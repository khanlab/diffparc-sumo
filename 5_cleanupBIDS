#!/bin/bash


function usage {
 echo ""
 echo "Usage: ${0##*/}  <working dir> <output bids dir> <subjids..>"
 echo "" 
 
}

if [ "$#" -lt 2 ]
then
 usage
 exit 1
fi

execpath=`dirname $0`
execpath=`realpath $execpath`

work_dir=$1
out_bids=$2

mkdir -p $out_bids
out_bids=`realpath $out_bids`

shift 2

source $parcellate_cfg


for subj_sess_prefix in $@
do

#check if has session-level
subj=${subj_sess_prefix%%_ses*}
if [ "$subj" = "$subj_sess_prefix" ]
then
    #no session level
    subj_sess_dir=$subj
else
    sess=${subj_sess_prefix##*_}
    subj_sess_dir=$subj/$sess
fi

echo subj_sess_dir: $subj_sess_dir
echo subj_sess_prefix: $subj_sess_prefix
subj_dir=$work_dir/$subj_sess_prefix

track_dir=$work_dir/${subj_sess_prefix}/bedpost.${parcellation_name}/probtrack

t1w_subj=$work_dir/${subj_sess_prefix}/t1/t1.brain.inorm.nii.gz
dti_parc_subj=$track_dir/diffusion_parcellation.masked.nii.gz
dti_parc_subj_mni=$track_dir/$atlas/diffusion_parcellation.masked.nii.gz
dti_parc_subj_normmax=$track_dir/diffusion_parcellation.masked.normMax.nii.gz
dti_parc_subj_mni_normmax=$track_dir/$atlas/diffusion_parcellation.masked.normMax.nii.gz

paths_parc_subj_mni=$work_dir/${subj_sess_prefix}/bedpost.${parcellation_name}/probtrack_parcels_to_targets/$atlas/seg_paths.$atlas.nii.gz
paths_parc_subj=$work_dir/${subj_sess_prefix}/bedpost.${parcellation_name}/probtrack_parcels_to_targets/seg_paths.nii.gz

t1w_seed_seg=$work_dir/${subj_sess_prefix}/$seed_file
t1w_target_seg=$work_dir/${subj_sess_prefix}/$target_seg

out_subj_dir=$out_bids/${subj_sess_dir}/anat
mkdir -p $out_subj_dir

out_t1w=$out_subj_dir/${subj_sess_prefix}_T1w.nii.gz
out_parc=$out_subj_dir/${subj_sess_prefix}_space-T1w_${bids_tags}_norm-off_diffparc.nii.gz
out_parc_mni=$out_subj_dir/${subj_sess_prefix}_reg-affine_space-${atlas}_${bids_tags}_norm-off_diffparc.nii.gz
out_parc_normmax=$out_subj_dir/${subj_sess_prefix}_space-T1w_${bids_tags}_norm-max_diffparc.nii.gz
out_parc_mni_normmax=$out_subj_dir/${subj_sess_prefix}_reg-affine_space-${atlas}_${bids_tags}_norm-max_diffparc.nii.gz

out_t1w_seed_seg=$out_subj_dir/${subj_sess_prefix}_space-T1w_${bids_tags}_inseed.nii.gz
out_t1w_target_seg=$out_subj_dir/${subj_sess_prefix}_space-T1w_${bids_tags}_intargets.nii.gz

out_paths=$out_subj_dir/${subj_sess_prefix}_space-T1w_${bids_tags}_pathsparc.nii.gz
out_paths_mni=$out_subj_dir/${subj_sess_prefix}_reg-affine_space-${atlas}_${bids_tags}_pathsparc.nii.gz

ln -srfv $t1w_subj $out_t1w
ln -srfv $t1w_seed_seg $out_t1w_seed_seg
ln -srfv $t1w_target_seg $out_t1w_target_seg
ln -srfv $dti_parc_subj $out_parc
ln -srfv $dti_parc_subj_mni $out_parc_mni

ln -srfv $dti_parc_subj_normmax $out_parc_normmax
ln -srfv $dti_parc_subj_mni_normmax $out_parc_mni_normmax

ln -srfv $paths_parc_subj $out_paths
ln -srfv $paths_parc_subj_mni $out_paths_mni

done #subj

